%PEMG UT Austin 2021
%Michael Solomentsev, Alex Hanson

% 1-D Zero Ampere Turns Method
% 8 Layers; 1/5/6/8 are paralleled
% Figure 14 (experimental, 8 layer green PCB)

syms b l r d I_p l2 r1 r2 r3 r4 r5 r6 r7 r8 h1 h2 h3 h4 h5 h6 h7 h8;
freq = 1*10^6;
calc_omega = 2*pi*freq;
calc_d = sqrt(2*1.68*10^-8/(calc_omega*1.256*10^-6)); 

 A = [
     %Primary Current Identity
     0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;...

     %Series Connections
     0 -1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;...
     0 0 -1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;...
     0 0 0 -1 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;...

     %K summation
     -1 0 0 0 0 0 0 0 b b 0 0 0 0 0 0 0 0 0 0 0 0 0 0;...
     0 -1 0 0 0 0 0 0 0 0 b b 0 0 0 0 0 0 0 0 0 0 0 0;...
     0 0 -1 0 0 0 0 0 0 0 0 0 b b 0 0 0 0 0 0 0 0 0 0;...
     0 0 0 -1 0 0 0 0 0 0 0 0 0 0 b b 0 0 0 0 0 0 0 0;...
     0 0 0 0 -1 0 0 0 0 0 0 0 0 0 0 0 b b 0 0 0 0 0 0;...
     0 0 0 0 0 -1 0 0 0 0 0 0 0 0 0 0 0 0 b b 0 0 0 0;...
     0 0 0 0 0 0 -1 0 0 0 0 0 0 0 0 0 0 0 0 0 b b 0 0;...
     0 0 0 0 0 0 0 -1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 b b;...
     
     %adjacent layers (Amperian Loops)
     0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;...
     0 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0;...
     0 0 0 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 0 0 0;...
     0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 0;...
     0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0;...
     0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0;...
     0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 0 0;...
     0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0;...
     0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1;...
     
     %Faraday loops btw secondaries
     %1 to 3
     %2*r*l/b r*l/b 0 0 0 0 0 0 0 .5*d*d 0 0 0 0 0 0 -.5*d*d 0 0 0 0 0 0 0;...

     %3 to 5
     %2*r*l/b 2*r*l/b 2*r*l/b r*l/b 0 0 0 0 0 0 0 0 0 0 0 0 0 .5*d*d -.5*d*d 0 0 0 0 0;...

     %5 to 7
     %2*r*l/b 2*r*l/b 2*r*l/b 2*r*l/b 2*r*l/b r*l/b 0 0 0 0 0 0 0 0 0 0 0 0 0 .5*d*d 0 0 -.5*d*d 0;...
     
     %1 to 5
     (r1+r2+r3+r4)*l/b (r2+r3+r4)*l/b (r3+r4)*l/b r4*l/b 0 0 0 0 0 .5*d*d 0 0 0 0 0 0 -.5*d*d 0 0 0 0 0 0 0;...

     %5 to 6
     r5*l/b r5*l/b r5*l/b r5*l/b r5*l/b 0 0 0 0 0 0 0 0 0 0 0 0 .5*d*d -.5*d*d 0 0 0 0 0;...

     %6 to 8
     (r6+r7)*l/b (r6+r7)*l/b (r6+r7)*l/b (r6+r7)*l/b (r6+r7)*l/b (r6+r7)*l/b r7*l/b 0 0 0 0 0 0 0 0 0 0 0 0 .5*d*d 0 0 -.5*d*d 0;
];

A = subs(A,r1,.000185);
A = subs(A,r2,.000185);
A = subs(A,r3,.00013);
A = subs(A,r4,.000185);
A = subs(A,r5,.00013);
A = subs(A,r6,.000185);
A = subs(A,r7,.000185);
A = subs(A,b,.02);
A = subs(A,d,calc_d);
A = subs(A, l,.46);
B = [
     
     I_p;
     0; 0; 0;
     0; 0; 0; 0; 0; 0; 0; 0; 0;
     0; 0; 0; 0; 0; 0; 0; 0;
     0; 0; 0;
     ];
 
B = subs(B,I_p,1);
 
X= double(simplify(linsolve(A,B)));
ratio = X(1)/X(8)